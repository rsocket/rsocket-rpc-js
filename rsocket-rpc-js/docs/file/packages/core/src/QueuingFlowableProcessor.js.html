<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">packages/core/src/QueuingFlowableProcessor.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core-src">core/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/core/src/RequestHandlingRSocket.js~RequestHandlingRSocket.html">RequestHandlingRSocket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/core/src/RpcClient.js~RpcClient.html">RpcClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/core/src/SwitchTransformOperator.js~SwitchTransformOperator.html">SwitchTransformOperator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ClientConfig">ClientConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DuplexConnection">DuplexConnection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Encodable">Encodable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Flowable">Flowable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Payload">Payload</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PayloadSerializers">PayloadSerializers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ReactiveSocket">ReactiveSocket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Responder">Responder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Serializer">Serializer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Setup">Setup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Single">Single</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/rsocket/rsocket-js/blob/master/packages/rsocket-types/src/ReactiveStreamTypes.js">ISubscription</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#frames-src">frames/src</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeMetadata">encodeMetadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMetadata">getMetadata</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getMethod">getMethod</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getService">getService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTracing">getTracing</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getVersion">getVersion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-METHOD_LENGTH_SIZE">METHOD_LENGTH_SIZE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVICE_LENGTH_SIZE">SERVICE_LENGTH_SIZE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TRACING_LENGTH_SIZE">TRACING_LENGTH_SIZE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-VERSION">VERSION</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-VERSION_SIZE">VERSION_SIZE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Buffer">Buffer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-BufferEncoder">BufferEncoder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Encoder">Encoder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-UTF8Encoder">UTF8Encoder</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#metrics-src">metrics/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/BaseMeter.js~BaseMeter.html">BaseMeter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/Counter.js~Counter.html">Counter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/Histogram.js~Histogram.html">Histogram</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/Metrics.js~Metrics.html">Metrics</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/MetricsExporter.js~MetricsExporter.html">MetricsExporter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/MetricsSubscriber.js~MetricsSubscriber.html">MetricsSubscriber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/RawMeterTag.js~RawMeterTag.html">RawMeterTag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/SimpleMeterRegistry.js~SimpleMeterRegistry.html">SimpleMeterRegistry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/Timer.js~Timer.html">Timer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-embedMetricsSingleSubscriber">embedMetricsSingleSubscriber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_PERCENTILES">DEFAULT_PERCENTILES</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#metrics-src-stats">metrics/src/stats</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/stats/ExponentiallyDecayingSample.js~ExponentiallyDecayingSample.html">ExponentiallyDecayingSample</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/stats/ExponentiallyWeightedMovingAverage.js~EWMA.html">EWMA</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/stats/Sample.js~Sample.html">Sample</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/metrics/src/stats/UniformSample.js~UniformSample.html">UniformSample</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#tracing-src">tracing/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/tracing/src/SpanSubscriber.js~SpanSubscriber.html">SpanSubscriber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createSpanSingle">createSpanSingle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bufferToMap">bufferToMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deserializeTraceData">deserializeTraceData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mapToBuffer">mapToBuffer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trace">trace</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-traceAsChild">traceAsChild</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-traceSingle">traceSingle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-traceSingleAsChild">traceSingleAsChild</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">packages/core/src/QueuingFlowableProcessor.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @name QueuingFlowableProcessor.js
 * @fileoverview Defines the {@link QueuingFlowableProcessor} class.
 *
 * @requires NPM:rsocket-types
 * @exports QueuingFlowableProcessor
 */

/**
 * An asynchronous, pull-based stream of values. Call the
 * {@link IPublisher#subscribe} method to generate a call to the subscriber&apos;s
 * {@link onSubscribe} method with a {@link Subscription} object that has two
 * methods: {@link Subscription#cancel} and {@link Subscription#request}.
 *
 * @see https://github.com/rsocket/rsocket-js/blob/master/packages/rsocket-types/src/ReactiveStreamTypes.js
 * @interface IPublisher
 */
/**
 * A version of the {@link ISubscriber} interface in which the methods are
 * optional, so that you may elect to only implement a subset of them.
 *
 * @see https://github.com/rsocket/rsocket-js/blob/master/packages/rsocket-types/src/ReactiveStreamTypes.js
 * @interface IPartialSubscriber
 */
/**
 * A handler for values provided by a Publisher.
 * @see https://github.com/rsocket/rsocket-js/blob/master/packages/rsocket-types/src/ReactiveStreamTypes.js
 * @interface ISubscriber
 */
/**
 * An underlying source of values for a Publisher.
 * @see https://github.com/rsocket/rsocket-js/blob/master/packages/rsocket-types/src/ReactiveStreamTypes.js
 * @external {ISubscription} https://github.com/rsocket/rsocket-js/blob/master/packages/rsocket-types/src/ReactiveStreamTypes.js
 */
import type {
  IPublisher,
  ISubscriber,
  IPartialSubscriber,
  ISubscription,
} from &apos;rsocket-types&apos;;

/**
 * MAX_REQUEST_N (from QueuingFlowableProcessor.js). If no {@link capacity} is
 * passed to the {@link QueuingFlowableProcessor#constructor}, this value will
 * be used as the capacity (the maximum number of items in the backlog queue).
 * This effectively signals that you want an unlimited number of items from the
 * source Flowable.
 *
 * @constant
 * @type {number}
 */
const MAX_REQUEST_N = 0x7fffffff; // uint31

/**
 * A {@link QueuingFlowableProcessor} is an intermediary between a Flowable
 * producer and a subscriber. To the producer, it behaves as a greedy subscriber
 * (that is, one that {@link request}s a large number of emissions immediately).
 * To the subscriber, it behaves as a {@link Flowable}.
 *
 * This allows the producer to generate and emit items at its own fast pace, while
 * the end subscriber requests them at its own slow pace. In between, the
 * {@link QueuingFlowableProcessor} queues up the backlog of items.
 */
export default class QueuingFlowableProcessor&lt;T&gt;
  implements IPublisher, ISubscriber, ISubscription {
  _once: boolean;
  _actual: Subscriber&lt;T&gt;;
  _requested: number;
  _capacity: number;
  _queue: T[];
  _wip: number;
  _cancelled: boolean;
  _done: boolean;
  _error: ?Error;

  /**
   * @param {?number} [capacity] - the maximum size of the backlog queue of
   * items this {@link QueuingFlowableProcessor} will maintain (default =
   * {@link MAX_REQUEST_N}). If this queue size is exceeded, the
   * {@link QueuingFlowableProcessor} will begin to drop incoming items from the
   * producer.
   */
  constructor(capacity?: number) {
    this._once = false;
    this._requested = 0;
    /** @type {Subscriber&lt;T&gt;} */
    this._actual = null;
    /** @type {?Error} */
    this._error = null;
    this._done = false;
    this._wip = 0;
    this._cancelled = false;
    /** @type {number} */
    this._capacity = capacity;
    /** @type {T[]} */
    this._queue = [];
    /** @type {function[]} */
    this._transformers = [];
  }

  /**
   * The subscriber to this {@link QueuingFlowableProcessor} subscribes by calling
   * this method.
   *
   * @param {Subscriber&lt;T&gt;} s - an object that implements the Subscriber methods
   *   this {@link QueuingFlowableProcessor} will call to pass along messages
   *   from the Flowable producer.
   * @throws {Error} if a Subscriber is already subscribed to this
   *   {@link QueuingFlowableProcessor}
   */
  subscribe(s: Subscriber&lt;T&gt;) {
    if (!this._once) {
      this._once = true;
      this._actual = s;
      s.onSubscribe(this);
    } else {
      throw new Error(&apos;Only one Subscriber allowed&apos;);
    }
  }

  /**
   * When the {@link QueuingFlowableProcessor} gets an {@link onSubscribe} call
   * from the {@link Flowable} producer, it requests that the {@link Flowable}
   * begin sending it items: either {@link capacity} items, if the capacity was
   * set during the call to {@link QueuingFlowableProcessor#constructor}, or
   * {@link MAX_REQUEST_N} items (effectively unlimited).
   *
   * @param {ISubscription} s - the subscription from the source {@link Flowable}
   */
  onSubscribe(s: ISubscription) {
    if (this._done) {
      s.cancel();
    } else {
      s.request(this._capacity || MAX_REQUEST_N);
    }
  }

  /**
   * The {@link Flowable} producer calls this method to add an item to the queue
   * of this {@link QueuingFlowableProcessor} for later emission to its
   * subscriber.
   *
   * @param {T} t - the item to add
   * @throws {Error} if {@link t} is null. Flowables are not permitted to emit
   *   null values.
   */
  onNext(t: T) {
    if (t === null) {
      throw new Error(&apos;t is null&apos;);
    }
    if (!this._capacity || this._queue.length &lt; this._capacity) {
      this._queue.push(t);
    }
    this.drain();
  }

  /**
   * The {@link Flowable} producer calls this method to signal to this
   * {@link QueuingFlowableProcessor} that the producer has encountered an error.
   * The {@link QueuingFlowableProcessor} will pass this error on to its
   * subscriber after it has finished sending the remaining items in its queue.
   *
   * @param {Error} t - the specific error
   */
  onError(t: Error) {
    if (t === null) {
      throw new Error(&apos;t is null&apos;);
    }
    this._error = t;
    this._done = true;
    this.drain();
  }

  /**
   * The {@link Flowable} producer calls this method to signal to this
   * {@link QueuingFlowableProcessor} that the producer has finished emitting
   * items. The {@link QueuingFlowableProcessor} will pass this message on to its
   * subscriber after it has finished sending the remaining items in its queue.
   */
  onComplete() {
    this._done = true;
    this.drain();
  }

  /**
   * The subscriber to this {@link QueuingFlowableProcessor} calls this method to
   * request a certain number of additional items.
   *
   * @example &lt;caption&gt;Note that requests are additive:&lt;/caption&gt;
   * // this is equivalent to request(5):
   * myQFP.request(2);
   * myQFP.request(3);
   *
   * @param {number} n - the number of items to request
   * @throws {Error} if {@link n} is zero or negative
   */
  request(n: number) {
    if (n &gt; 0) {
      this._requested += n;
      this.drain();
    } else {
      throw new Error(&apos;Invalid N for request, must be &gt; 0: &apos; + n);
    }
  }

  /**
   * The subscriber to this {@link QueuingFlowableProcessor} calls this method to
   * indicate that it wants no more items and that the
   * {@link QueuingFlowableProcessor} can stop work and empty its queue.
   */
  cancel() {
    this._cancelled = true;
    if (this._wip++ === 0) {
      this._actual = null;
      this._queue = [];
    }
  }

  /**
   * Add a mapping function that modifies each emission from the {@link Flowable}
   * producer before emitting it from the {@link QueuingFlowableProcessor}. Note
   * that you can call this multiple times to add multiple mapping functions,
   * each of which will operate on the outputs of its predecessor.
   *
   * @param {function} transformer - a transformation function that accepts an
   *   item emitted by the {@link Flowable} producer and returns an item
   *   expected by the subscriber or by the next transformer
   * @return {QueuingFlowableProcessor} this same processor, modified with the
   *   transformation function
   */
  map(transformer) {
    this._transformers.push(transformer);
    return this;
  }

  /**
   * Drain the existing queue of items that are ready for emission by the
   * {@link QueuingFlowableProcessor} by emitting them to its subscriber. This
   * is typically called implicitly by other methods of the
   * {@link QueuingFlowableProcessor}, not explicitly by the producer or
   * subscriber.
   */
  drain() {
    if (this._actual == null) {
      return;
    }
    if (this._wip++ !== 0) {
      return;
    }

    const missed = 1;

    for (;;) {
      const r = this._requested;
      let e = 0;

      while (e !== r) {
        if (this._cancelled) {
          this._actual = null;
          this._queue = [];
          return;
        }

        const d = this._done;
        const v = this._queue.shift();
        const empty = v == null;

        if (d &amp;&amp; empty) {
          if (this._actual != null) {
            const ex = this._error;
            if (ex != null) {
              this._actual.onError(ex);
            } else {
              this._actual.onComplete();
            }
            this._actual = null;
          }
          return;
        }

        if (empty) {
          break;
        }

        if (this._actual != null) {
          const transformedV = this._transformers.reduce(
            (interim, xform) =&gt; xform(interim),
            v,
          );
          this._actual.onNext(transformedV);
        }

        e++;
      }

      if (e == r) {
        if (this._cancelled) {
          this._actual = null;
          this._queue = [];
          return;
        }
        const d = this._done;
        const empty = this._queue.length === 0;

        if (d &amp;&amp; empty) {
          if (this._actual != null) {
            const ex = this._error;
            if (ex != null) {
              this._actual.onError(ex);
            } else {
              this._actual.onComplete();
            }
            this._actual = null;
          }
          return;
        }
      }

      if (e != 0) {
        this._requested -= e;
      }

      const m = this._wip - missed;
      this._wip = m;
      if (m == 0) {
        break;
      }
    }
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
